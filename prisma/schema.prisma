
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  status    String   @default("active")
  timezone  String   @default("UTC")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  editedAt  DateTime? @map("edited_at")
  deletedAt DateTime? @map("deleted_at")

  users         User[]
  teams         Team[]
  roles         Role[]
  auditLogs     AuditLog[]
  moduleConfigs ModuleConfig[]
  moduleEventSubscriptions ModuleEventSubscription[]
  rolePermissions RolePermission[]
  userRoles     UserRole[]
  userPermissions UserPermission[]
  files         File[]
  iconAssets    IconAsset[]
  notes         Note[]
  userRequests  UserRequest[]
  financeEntries FinanceEntry[]
  leadSources   LeadSource[]
  contacts      Contact[]
  contactChannels ContactChannel[]
  leads         Lead[]
  leadContacts  LeadContact[]
  leadTags      LeadTag[]
  leadTagLinks  LeadTagLink[]
  leadAssignments LeadAssignment[]
  leadActivityLogs LeadActivityLog[]
  leadTasks     LeadTask[]
  tasks         Task[]
  callLogs      CallLog[]
  leadStateDefinitions LeadStateDefinition[]
  leadStateTransitions LeadStateTransition[]
  leadStateHistory LeadStateHistory[]
  leadDeadlines LeadDeadline[]
  leadExtensions LeadExtension[]
  leadFailures LeadFailure[]
  leadClosures LeadClosure[]
  properties    Property[]
  propertyUnits PropertyUnit[]
  listings      Listing[]
  listingMedia  ListingMedia[]
  inquiries     Inquiry[]
  deals         Deal[]
  offers        Offer[]
  meetings      Meeting[]
  meetingParticipants MeetingParticipant[]
  meetingRooms  MeetingRoom[]
  meetingRescheduleRequests MeetingRescheduleRequest[]
  meetingReminders MeetingReminder[]
  reassignmentRules ReassignmentRule[]
  reassignmentPools ReassignmentPool[]
  poolMembers   PoolMember[]
  negligencePoints NegligencePoint[]
  reassignmentEvents ReassignmentEvent[]
  whatsappAccounts WhatsappAccount[]
  whatsappTemplates WhatsappTemplate[]
  whatsappMessages WhatsappMessage[]
  whatsappWebhooks WhatsappWebhook[]
  whatsappOptOuts WhatsappOptOut[]
  reminderRules ReminderRule[]
  reminderSchedules ReminderSchedule[]
  remindersSent RemindersSent[]
  commissionPlans CommissionPlan[]
  commissionRules CommissionRule[]
  commissionLedger CommissionLedger[]
  commissionApprovals CommissionApproval[]
  blacklistEntries BlacklistEntry[]
  blacklistMatches BlacklistMatch[]
  riskScores    RiskScore[]
  leadScores    LeadScore[]
  leadMetricsDaily LeadMetricsDaily[]
  disciplineIndexSnapshots DisciplineIndexSnapshot[]
  rankingSnapshots RankingSnapshot[]
  notificationEvents NotificationEvent[]
  notificationRules NotificationRule[]
  notificationDeliveries NotificationDelivery[]
  notificationQuotas NotificationQuota[]
  goalPlans    GoalPlan[]
  goalTargets  GoalTarget[]
  scheduledJobs ScheduledJob[]
  jobRuns       JobRun[]
  userProfiles  UserProfile[]
  teamMembers   TeamMember[]
  conversations Conversation[]
  conversationParticipants ConversationParticipant[]
  messages      Message[]

  @@index([status])
  @@index([createdAt])
  @@map("tenants")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  email        String   @unique
  phone        String?
  passwordHash String   @map("password_hash")
  mustChangePassword Boolean @default(true) @map("must_change_password")
  status       String   @default("active")
  lastLoginAt  DateTime? @map("last_login_at")
  isOnline     Boolean   @default(false) @map("is_online")
  lastSeen     DateTime? @map("last_seen")
  lastNotificationClearTime DateTime? @map("last_notification_clear_time")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  tenant        Tenant @relation(fields: [tenantId], references: [id])
  profile       UserProfile?
  teamsLed      Team[] @relation("TeamLeader")
  teamMembers   TeamMember[]
  roleLinks     UserRole[]
  leadAssignments LeadAssignment[]
  leadActivities LeadActivityLog[]
  callLogs      CallLog[]
  meetings      Meeting[] @relation("MeetingOrganizer")
  meetingReschedules MeetingRescheduleRequest[]
  reassignmentFrom ReassignmentEvent[] @relation("ReassignFrom")
  reassignmentTo   ReassignmentEvent[] @relation("ReassignTo")
  negligencePoints NegligencePoint[]
  commissionLedger CommissionLedger[]
  leadMetricsDaily LeadMetricsDaily[]
  disciplineIndexSnapshots DisciplineIndexSnapshot[]
  notificationQuotas NotificationQuota[]
  poolMembers PoolMember[]
  filesCreated File[]
  iconAssetsCreated IconAsset[]
  notesCreated Note[]
  leadExtensionsRequested LeadExtension[] @relation("ExtensionRequester")
  leadExtensionsApproved LeadExtension[] @relation("ExtensionApprover")
  assignedLeads Lead[]
  createdLeads  Lead[] @relation("LeadCreator")
  assignedTasks LeadTask[]
  tasks         Task[]
  createdTasks  Task[] @relation("TaskCreator")
  auditLogs     AuditLog[]
  leadStateChanges LeadStateHistory[]
  leadFailures LeadFailure[]
  leadClosuresClosed LeadClosure[] @relation("LeadClosureActor")
  leadClosuresDecided LeadClosure[] @relation("LeadClosureDecider")
  userRequestsRequested UserRequest[] @relation("UserRequestRequester")
  userRequestsDecided UserRequest[] @relation("UserRequestDecider")
  financeEntries FinanceEntry[]
  userPermissions UserPermission[]
  conversationParticipants ConversationParticipant[]
  messagesSent Message[]
  approvedDeals Deal[] @relation("DealApprover")
  meetingParticipants MeetingParticipant[]

  // Notifications
  notificationsReceived NotificationDelivery[]
  notificationsSent     NotificationDelivery[] @relation("NotificationSender")
  
  approvedCommissions CommissionApproval[] @relation("CommissionApprover")

  @@index([tenantId, email])
  @@index([tenantId, status])
  @@index([lastLoginAt])
  @@map("users")
}

model UserProfile {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @unique @db.Uuid @map("user_id")
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  avatarFileId String? @db.Uuid @map("avatar_file_id")
  locale    String   @default("en")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  user  User @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
  avatarFile File? @relation(fields: [avatarFileId], references: [id])

  @@index([tenantId, userId])
  @@map("user_profiles")
}

model Team {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  name         String
  leaderUserId String?  @db.Uuid @map("leader_user_id")
  status       String   @default("active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  leader User? @relation("TeamLeader", fields: [leaderUserId], references: [id])
  members TeamMember[]
  leads   Lead[]
  leadMetricsDaily LeadMetricsDaily[]

  @@index([tenantId, leaderUserId])
  @@index([tenantId, status])
  @@unique([tenantId, name])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  teamId    String   @db.Uuid @map("team_id")
  userId    String   @db.Uuid @map("user_id")
  role      String   @default("member")
  lastReadAt DateTime? @map("last_read_at")
  joinedAt  DateTime @default(now()) @map("joined_at")
  leftAt    DateTime? @map("left_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  team   Team @relation(fields: [teamId], references: [id])
  user   User @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, teamId])
  @@index([tenantId, userId])
  @@map("team_members")
}

model Role {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  name         String
  scope        String   @default("tenant")
  parentRoleId String?  @db.Uuid @map("parent_role_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  parent Role? @relation("RoleParent", fields: [parentRoleId], references: [id])
  children Role[] @relation("RoleParent")
  permissions RolePermission[]
  userRoles UserRole[]

  @@index([tenantId, name])
  @@index([parentRoleId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  description String?
  moduleKey   String?  @map("module_key")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  rolePermissions RolePermission[]
  modulePermissions ModulePermission[]
  userPermissions UserPermission[]

  @@index([moduleKey])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  roleId       String   @db.Uuid @map("role_id")
  permissionId String   @db.Uuid @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  role Role @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, roleId])
  @@index([tenantId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid @map("tenant_id")
  userId     String   @db.Uuid @map("user_id")
  roleId     String   @db.Uuid @map("role_id")
  assignedBy String?  @db.Uuid @map("assigned_by")
  assignedAt DateTime @default(now()) @map("assigned_at")
  revokedAt  DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, roleId])
  @@map("user_roles")
}

model UserPermission {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid @map("tenant_id")
  userId       String   @db.Uuid @map("user_id")
  permissionId String   @db.Uuid @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, userId])
  @@map("user_permissions")
}

model ModuleConfig {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  moduleKey String   @map("module_key")
  config    Json
  isEnabled Boolean  @default(true) @map("is_enabled")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, moduleKey])
  @@map("module_configs")
}

model ModulePermission {
  id           String   @id @default(uuid()) @db.Uuid
  moduleKey    String   @map("module_key")
  permissionId String   @db.Uuid @map("permission_id")

  permission Permission @relation(fields: [permissionId], references: [id])

  @@index([moduleKey])
  @@map("module_permissions")
}

model ModuleEventSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  moduleKey String   @map("module_key")
  event     String
  webhookUrl String  @map("webhook_url")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, moduleKey])
  @@map("module_event_subscriptions")
}

model File {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  filename  String
  mimetype  String
  size      Int
  path      String
  url       String?
  uploadedBy String? @db.Uuid @map("uploaded_by")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  uploader User? @relation(fields: [uploadedBy], references: [id])
  userProfiles UserProfile[]
  iconAssets IconAsset[]
  recordings CallLog[]
  listingMedia ListingMedia[]
  
  @@index([tenantId, uploadedBy])
  @@map("files")
}

model IconAsset {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  fileId    String   @db.Uuid @map("file_id")
  uploadedBy String? @db.Uuid @map("uploaded_by")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  file File @relation(fields: [fileId], references: [id])
  uploader User? @relation(fields: [uploadedBy], references: [id])

  @@index([tenantId, name])
  @@map("icon_assets")
}

model Note {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  content   String
  relatedTo String?  @map("related_to")
  relatedId String?  @db.Uuid @map("related_id")
  createdBy String?  @db.Uuid @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  creator User? @relation(fields: [createdBy], references: [id])

  @@index([tenantId, relatedId])
  @@map("notes")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String?  @db.Uuid @map("user_id")
  actorUserId String? @db.Uuid @map("actor_user_id") // Added missing column
  action    String
  entityType String   @map("entity_type") // Renamed from entity to entity_type
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
  @@map("audit_logs")
}

model LeadSource {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, isActive])
  @@map("lead_sources")
}

model Contact {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  phone     String?
  email     String?
  type      String   @default("individual")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  channels ContactChannel[]
  leadContacts LeadContact[]
  meetingParticipants MeetingParticipant[]

  @@index([tenantId, phone])
  @@index([tenantId, email])
  @@map("contacts")
}

model ContactChannel {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  contactId String   @db.Uuid @map("contact_id")
  type      String
  value     String
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  contact Contact @relation(fields: [contactId], references: [id])

  @@index([tenantId, contactId])
  @@map("contact_channels")
}

model Lead {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadCode  String   @map("lead_code")
  name      String
  phone     String
  email     String?
  budget    Decimal? @db.Decimal(14, 2)
  areaOfInterest String? @map("area_of_interest")
  sourceLabel String? @map("source_label")
  sourceId  String?  @db.Uuid @map("source_id")
  assignedUserId String? @db.Uuid @map("assigned_user_id")
  teamId    String?  @db.Uuid @map("team_id")
  status    String   @default("new")
  priority  String   @default("normal")
  budgetMin Decimal? @map("budget_min") @db.Decimal(14, 2)
  budgetMax Decimal? @map("budget_max") @db.Decimal(14, 2)
  desiredLocation String? @map("desired_location")
  propertyType String? @map("property_type")
  profession String?
  notes     String?
  
  lifecycleStage String @default("new") @map("lifecycle_stage")
  timerStartDate DateTime? @map("timer_start_date")
  isTimerExtended Boolean @default(false) @map("is_timer_extended")
  isWrongNumber Boolean @default(false) @map("is_wrong_number") // Added missing column
  
  createdByUserId String? @db.Uuid @map("created_by_user_id")
  createdByUser   User?   @relation("LeadCreator", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  assignedUser User? @relation(fields: [assignedUserId], references: [id])
  team Team? @relation(fields: [teamId], references: [id])
  contacts LeadContact[]
  tags LeadTagLink[]
  assignments LeadAssignment[]
  activities LeadActivityLog[]
  tasks LeadTask[]
  callLogs CallLog[]
  stateHistory LeadStateHistory[]
  deadlines LeadDeadline[]
  extensions LeadExtension[]
  failures LeadFailure[]
  closures LeadClosure[]
  meetings Meeting[]
  listings Listing[]
  deals Deal[]
  negligencePoints NegligencePoint[]

  @@unique([tenantId, leadCode])
  @@unique([tenantId, phone]) // Enforce unique phone per tenant
  @@index([tenantId, status])
  @@index([tenantId, assignedUserId])
  @@index([tenantId, createdAt])
  @@map("leads")
}

model LeadContact {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  contactId String   @db.Uuid @map("contact_id")
  role      String   @default("primary")
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])
  contact Contact @relation(fields: [contactId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, contactId])
  @@map("lead_contacts")
}

model LeadTag {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  links LeadTagLink[]

  @@index([tenantId, name])
  @@map("lead_tags")
}

model LeadTagLink {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  tagId     String   @db.Uuid @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])
  tag LeadTag @relation(fields: [tagId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, tagId])
  @@map("lead_tag_links")
}

model LeadAssignment {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  assignedUserId String @db.Uuid @map("assigned_user_id")
  assignedBy String? @db.Uuid @map("assigned_by")
  reason    String?
  assignedAt DateTime @default(now()) @map("assigned_at")
  releasedAt DateTime? @map("released_at")

  lead Lead @relation(fields: [leadId], references: [id])
  assignedUser User @relation(fields: [assignedUserId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, assignedUserId])
  @@index([assignedAt])
  @@map("lead_assignments")
}

model LeadActivityLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  actorUserId String? @db.Uuid @map("actor_user_id")
  activityType String @map("activity_type")
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])
  actor User? @relation(fields: [actorUserId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, actorUserId])
  @@index([createdAt])
  @@map("lead_activity_logs")
}

model LeadTask {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  assignedUserId String? @db.Uuid @map("assigned_user_id")
  taskType  String   @map("task_type")
  dueAt     DateTime? @map("due_at")
  status    String   @default("open")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") // Added missing column

  lead Lead @relation(fields: [leadId], references: [id])
  assignedUser User? @relation(fields: [assignedUserId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, assignedUserId])
  @@map("lead_tasks")
}

model Task {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  title     String
  description String?
  assignedUserId String? @db.Uuid @map("assigned_user_id")
  createdByUserId String? @db.Uuid @map("created_by_user_id")
  
  status    String   @default("open")
  priority  String   @default("medium")
  dueDate   DateTime? @map("due_date")
  
  relatedType String? @map("related_type")
  relatedId   String? @db.Uuid @map("related_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  assignedUser User? @relation(fields: [assignedUserId], references: [id])
  creator User? @relation("TaskCreator", fields: [createdByUserId], references: [id])

  @@index([tenantId, assignedUserId])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@map("tasks")
}

model CallLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  callerUserId String? @db.Uuid @map("caller_user_id")
  durationSeconds Int? @map("duration_seconds")
  callTime  DateTime @default(now()) @map("call_time")
  outcome   String?
  recordingFileId String? @db.Uuid @map("recording_file_id")
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])
  caller User? @relation(fields: [callerUserId], references: [id])
  recording File? @relation(fields: [recordingFileId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, callerUserId])
  @@index([callTime])
  @@map("call_logs")
}

model LeadStateDefinition {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  code      String
  name      String
  isTerminal Boolean @default(false) @map("is_terminal")
  slaHours  Int?     @map("sla_hours")
  questions Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  fromTransitions LeadStateTransition[] @relation("FromState")
  toTransitions LeadStateTransition[] @relation("ToState")
  stateHistoryFrom LeadStateHistory[] @relation("HistoryFrom")
  stateHistoryTo LeadStateHistory[] @relation("HistoryTo")
  deadlines LeadDeadline[]
  extensions LeadExtension[]

  @@index([tenantId, code])
  @@map("lead_state_definitions")
}

model LeadStateTransition {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  fromStateId String @db.Uuid @map("from_state_id")
  toStateId String   @db.Uuid @map("to_state_id")
  guardKey  String?  @map("guard_key")
  requiresApproval Boolean @default(false) @map("requires_approval")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  fromState LeadStateDefinition @relation("FromState", fields: [fromStateId], references: [id])
  toState LeadStateDefinition @relation("ToState", fields: [toStateId], references: [id])

  @@index([tenantId, fromStateId])
  @@index([tenantId, toStateId])
  @@map("lead_state_transitions")
}

model LeadStateHistory {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  fromStateId String? @db.Uuid @map("from_state_id")
  toStateId String   @db.Uuid @map("to_state_id")
  changedBy String?  @db.Uuid @map("changed_by")
  changedAt DateTime @default(now()) @map("changed_at")
  metadata  Json?
  answers   Json?

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])
  fromState LeadStateDefinition? @relation("HistoryFrom", fields: [fromStateId], references: [id])
  toState LeadStateDefinition @relation("HistoryTo", fields: [toStateId], references: [id])
  changer User? @relation(fields: [changedBy], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, changedAt])
  @@map("lead_state_history")
}

model LeadDeadline {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  stateId   String   @db.Uuid @map("state_id")
  dueAt     DateTime @map("due_at")
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])
  state LeadStateDefinition @relation(fields: [stateId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, dueAt])
  @@index([tenantId, status])
  @@map("lead_deadlines")
}

model LeadExtension {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  stateId   String   @db.Uuid @map("state_id")
  requestedBy String? @db.Uuid @map("requested_by")
  approvedBy String? @db.Uuid @map("approved_by")
  reason    String?
  extensionHours Int @map("extension_hours")
  status    String  @default("pending")
  requestedAt DateTime @default(now()) @map("requested_at")
  decidedAt DateTime? @map("decided_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])
  state LeadStateDefinition @relation(fields: [stateId], references: [id])
  requester User? @relation("ExtensionRequester", fields: [requestedBy], references: [id])
  approver User? @relation("ExtensionApprover", fields: [approvedBy], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, status])
  @@index([tenantId, requestedAt])
  @@map("lead_extensions")
}

model LeadFailure {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  failedBy  String?  @db.Uuid @map("failed_by")
  failureType String @map("failure_type")
  reason    String?
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")

  lead Lead @relation(fields: [leadId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
  actor User? @relation(fields: [failedBy], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("lead_failures")
}

model LeadClosure {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  closedBy  String?  @db.Uuid @map("closed_by")
  amount    Decimal  @db.Decimal(14, 2)
  note      String?
  address   String?
  status    String   @default("pending")
  decidedBy String?  @db.Uuid @map("decided_by")
  decidedAt DateTime? @map("decided_at")
  closedAt  DateTime @default(now()) @map("closed_at")

  lead Lead @relation(fields: [leadId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
  actor User? @relation("LeadClosureActor", fields: [closedBy], references: [id])
  decider User? @relation("LeadClosureDecider", fields: [decidedBy], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, status])
  @@index([tenantId, closedAt])
  @@map("lead_closures")
}

model UserRequest {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  requestedBy String @db.Uuid @map("requested_by")
  requestType String @map("request_type")
  payload   Json
  status    String   @default("pending")
  decidedBy String?  @db.Uuid @map("decided_by")
  decidedAt DateTime? @map("decided_at")
  createdAt DateTime @default(now()) @map("created_at")
  notes     String?

  tenant Tenant @relation(fields: [tenantId], references: [id])
  requester User @relation("UserRequestRequester", fields: [requestedBy], references: [id])
  decider User? @relation("UserRequestDecider", fields: [decidedBy], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("user_requests")
}

model FinanceEntry {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  entryType String   @map("entry_type")
  category  String
  amount    Decimal  @db.Decimal(14, 2)
  note      String?
  occurredAt DateTime @map("occurred_at")
  createdBy String?  @db.Uuid @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  creator User? @relation(fields: [createdBy], references: [id])

  @@index([tenantId, occurredAt])
  @@map("finance_entries")
}

model Property {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  type      String
  location  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  units PropertyUnit[]
  listings Listing[]

  @@index([tenantId, location])
  @@map("properties")
}

model PropertyUnit {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  propertyId String  @db.Uuid @map("property_id")
  unitNumber String  @map("unit_number")
  floor     Int?
  area      Decimal? @db.Decimal(10, 2)
  rooms     Int?
  bathrooms Int?
  status    String   @default("available")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  property Property @relation(fields: [propertyId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
  listings Listing[]

  @@index([tenantId, propertyId])
  @@map("property_units")
}

model Listing {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  propertyId String? @db.Uuid @map("property_id")
  unitId    String?  @db.Uuid @map("unit_id")
  leadId    String?  @db.Uuid @map("lead_id")
  type      String   // sale, rent
  price     Decimal  @db.Decimal(14, 2)
  currency  String   @default("EGP")
  status    String   @default("active")
  description String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  unit PropertyUnit? @relation(fields: [unitId], references: [id])
  lead Lead? @relation(fields: [leadId], references: [id])
  media ListingMedia[]
  deals Deal[]
  offers Offer[]

  @@index([tenantId, type])
  @@index([tenantId, status])
  @@map("listings")
}

model ListingMedia {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  listingId String   @db.Uuid @map("listing_id")
  fileId    String   @db.Uuid @map("file_id")
  type      String   // image, video, document
  isMain    Boolean  @default(false) @map("is_main")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])
  file File @relation(fields: [fileId], references: [id])

  @@index([tenantId, listingId])
  @@map("listing_media")
}

model Inquiry {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String?  @db.Uuid @map("lead_id")
  contactId String?  @db.Uuid @map("contact_id")
  content   String
  status    String   @default("new")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, status])
  @@map("inquiries")
}

model Deal {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  listingId String   @db.Uuid @map("listing_id")
  leadId    String   @db.Uuid @map("lead_id")
  dealId    String?  @db.Uuid @map("deal_id")
  price     Decimal  @db.Decimal(14, 2)
  netProfit Decimal? @map("net_profit") @db.Decimal(14, 2)
  
  status    String   @default("pending")
  approvalStatus String @default("pending") @map("approval_status")
  stage     String   @default("prospecting")
  
  approvedByUserId String? @db.Uuid @map("approved_by_user_id")
  approvedBy User? @relation("DealApprover", fields: [approvedByUserId], references: [id])

  closedAt  DateTime? @map("closed_at")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])
  commissions CommissionLedger[]
  lead Lead @relation(fields: [leadId], references: [id])
  offers Offer[]

  @@index([tenantId, status])
  @@map("deals")
}

model Offer {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  listingId String   @db.Uuid @map("listing_id")
  leadId    String   @db.Uuid @map("lead_id")
  dealId    String?  @db.Uuid @map("deal_id")
  price     Decimal  @db.Decimal(14, 2)
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])
  deal Deal? @relation(fields: [dealId], references: [id])

  @@index([tenantId, status])
  @@map("offers")
}

model Meeting {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  organizerUserId String @db.Uuid @map("organizer_user_id")
  title     String
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  timezone  String   @default("UTC")
  location  String?
  status    String   @default("scheduled")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])
  organizer User @relation("MeetingOrganizer", fields: [organizerUserId], references: [id])
  participants MeetingParticipant[]
  rescheduleRequests MeetingRescheduleRequest[]
  reminders MeetingReminder[]

  @@index([tenantId, leadId])
  @@index([tenantId, organizerUserId])
  @@index([tenantId, startsAt])
  @@map("meetings")
}

model MeetingParticipant {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  meetingId String   @db.Uuid @map("meeting_id")
  userId    String?  @db.Uuid @map("user_id")
  contactId String?  @db.Uuid @map("contact_id")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  meeting Meeting @relation(fields: [meetingId], references: [id])
  user User? @relation(fields: [userId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([tenantId, meetingId])
  @@map("meeting_participants")
}

model MeetingRoom {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  capacity  Int
  location  String?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, name])
  @@map("meeting_rooms")
}

model MeetingRescheduleRequest {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  meetingId String   @db.Uuid @map("meeting_id")
  requestedBy String @db.Uuid @map("requested_by")
  suggestedStart DateTime @map("suggested_start")
  suggestedEnd DateTime @map("suggested_end")
  reason    String?
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  meeting Meeting @relation(fields: [meetingId], references: [id])
  requester User @relation(fields: [requestedBy], references: [id])

  @@index([tenantId, meetingId])
  @@map("meeting_reschedule_requests")
}

model MeetingReminder {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  meetingId String   @db.Uuid @map("meeting_id")
  minutesBefore Int  @map("minutes_before")
  method    String   @default("notification") // notification, email, sms
  isSent    Boolean  @default(false) @map("is_sent")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  meeting Meeting @relation(fields: [meetingId], references: [id])

  @@index([tenantId, meetingId])
  @@map("meeting_reminders")
}

model ReassignmentRule {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  condition Json     // e.g. { "days_inactive": 7, "status": "new" }
  action    Json     // e.g. { "reassign_to": "pool", "pool_id": "..." }
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("reassignment_rules")
}

model ReassignmentPool {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  strategy  String   @default("round_robin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  members PoolMember[]

  @@map("reassignment_pools")
}

model PoolMember {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  poolId    String   @db.Uuid @map("pool_id")
  userId    String   @db.Uuid @map("user_id")
  weight    Int      @default(1)
  lastAssignedAt DateTime? @map("last_assigned_at")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  pool ReassignmentPool @relation(fields: [poolId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([tenantId, poolId])
  @@map("pool_members")
}

model NegligencePoint {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  userId    String   @db.Uuid @map("user_id")
  points    Int
  reason    String
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id])
  user User @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, leadId])
  @@map("negligence_points")
}

model ReassignmentEvent {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  fromUserId String? @db.Uuid @map("from_user_id")
  toUserId  String?  @db.Uuid @map("to_user_id")
  reason    String?
  occurredAt DateTime @default(now()) @map("occurred_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  fromUser User? @relation("ReassignFrom", fields: [fromUserId], references: [id])
  toUser User? @relation("ReassignTo", fields: [toUserId], references: [id])

  @@index([tenantId, leadId])
  @@map("reassignment_events")
}

model WhatsappAccount {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  phoneNumber String @map("phone_number")
  displayName String? @map("display_name")
  isConnected Boolean @default(false) @map("is_connected")
  config    Json?    // API keys, etc
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  templates WhatsappTemplate[]
  messages WhatsappMessage[]

  @@index([tenantId, phoneNumber])
  @@map("whatsapp_accounts")
}

model WhatsappTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  accountId String   @db.Uuid @map("account_id")
  name      String
  content   String
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  account WhatsappAccount @relation(fields: [accountId], references: [id])

  @@index([tenantId, accountId])
  @@map("whatsapp_templates")
}

model WhatsappMessage {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  accountId String   @db.Uuid @map("account_id")
  toPhone   String   @map("to_phone")
  content   String
  status    String   @default("queued") // queued, sent, delivered, read, failed
  sentAt    DateTime? @map("sent_at")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  account WhatsappAccount @relation(fields: [accountId], references: [id])

  @@index([tenantId, accountId])
  @@index([tenantId, toPhone])
  @@map("whatsapp_messages")
}

model WhatsappWebhook {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  url       String
  events    Json     // array of event names
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("whatsapp_webhooks")
}

model WhatsappOptOut {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  phone     String
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, phone])
  @@map("whatsapp_opt_outs")
}

model ReminderRule {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  condition Json     // e.g. { "state": "call", "hours_inactive": 24 }
  message   String
  method    String   @default("notification") // notification, whatsapp, email
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  schedules ReminderSchedule[]

  @@map("reminder_rules")
}

model ReminderSchedule {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  ruleId    String   @db.Uuid @map("rule_id")
  leadId    String   @db.Uuid @map("lead_id")
  dueAt     DateTime @map("due_at")
  status    String   @default("pending") // pending, sent, cancelled
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  rule ReminderRule @relation(fields: [ruleId], references: [id])
  
  @@index([tenantId, leadId])
  @@index([tenantId, dueAt])
  @@map("reminder_schedules")
}

model RemindersSent {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  content   String
  method    String
  sentAt    DateTime @default(now()) @map("sent_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@map("reminders_sent")
}

model CommissionPlan {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  targetAmount Decimal @db.Decimal(14, 2) @map("target_amount")
  baseRate  Decimal  @db.Decimal(5, 2) @map("base_rate") // percentage
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  rules CommissionRule[]

  @@map("commission_plans")
}

model CommissionRule {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  planId    String   @db.Uuid @map("plan_id")
  rule      Json?
  minAmount Decimal? @db.Decimal(14, 2) @map("min_amount")
  maxAmount Decimal? @db.Decimal(14, 2) @map("max_amount")
  rate      Decimal? @db.Decimal(5, 2)
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan CommissionPlan @relation(fields: [planId], references: [id])

  @@index([tenantId, planId])
  @@map("commission_rules")
}

model CommissionLedger {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @db.Uuid @map("user_id")
  dealId    String?  @db.Uuid @map("deal_id")
  leadId    String?  @db.Uuid @map("lead_id")
  amount    Decimal  @db.Decimal(14, 2)
  currency  String   @default("USD")
  entryType String   @map("entry_type")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user User @relation(fields: [userId], references: [id])
  deal Deal? @relation(fields: [dealId], references: [id])
  approvals CommissionApproval[]

  @@index([tenantId, userId])
  @@map("commission_ledger")
}

model CommissionApproval {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  ledgerId  String   @db.Uuid @map("ledger_id")
  status    String   @default("pending")
  approvedBy String? @db.Uuid @map("approved_by")
  decidedAt DateTime? @map("decided_at")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  ledger CommissionLedger @relation(fields: [ledgerId], references: [id])
  approver User? @relation("CommissionApprover", fields: [approvedBy], references: [id])

  @@index([tenantId, status])
  @@map("commission_approvals")
}

model BlacklistEntry {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  phone     String
  reason    String?
  addedBy   String?  @db.Uuid @map("added_by")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, phone])
  @@map("blacklist_entries")
}

model BlacklistMatch {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  entryId   String   @db.Uuid @map("entry_id")
  matchedAt DateTime @default(now()) @map("matched_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@map("blacklist_matches")
}

model RiskScore {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  score     Int
  factors   Json
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@map("risk_scores")
}

model LeadScore {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  leadId    String   @db.Uuid @map("lead_id")
  score     Int
  factors   Json
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId])
  @@map("lead_scores")
}

model LeadMetricsDaily {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  date      DateTime @db.Date
  userId    String?  @db.Uuid @map("user_id")
  teamId    String?  @db.Uuid @map("team_id")
  
  newLeadsCount Int @default(0) @map("new_leads_count")
  callsCount    Int @default(0) @map("calls_count")
  meetingsCount Int @default(0) @map("meetings_count")
  closingsCount Int @default(0) @map("closings_count")
  revenueAmount Decimal @default(0) @db.Decimal(14, 2) @map("revenue_amount")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user User? @relation(fields: [userId], references: [id])
  team Team? @relation(fields: [teamId], references: [id])

  @@unique([tenantId, date, userId, teamId])
  @@map("lead_metrics_daily")
}

model DisciplineIndexSnapshot {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @db.Uuid @map("user_id")
  date      DateTime @db.Date
  score     Int
  details   Json
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([tenantId, userId])
  @@map("discipline_index_snapshots")
}

model RankingSnapshot {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  period    String   // e.g. "2023-10"
  type      String   // "user" or "team"
  entityId  String   @db.Uuid @map("entity_id")
  rank      Int
  score     Int
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, period])
  @@map("ranking_snapshots")
}

model NotificationEvent {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  code      String   @unique
  name      String
  description String?
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("notification_events")
}

model NotificationRule {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  eventCode String   @map("event_code")
  channels  Json     // ["web", "email", "push"]
  recipients Json    // { "roles": ["admin"], "users": [] }
  template  String
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, eventCode])
  @@map("notification_rules")
}

model NotificationDelivery {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @db.Uuid @map("user_id")
  senderId  String?  @db.Uuid @map("sender_id") // Who triggered this notification?
  type      String   // info, success, warning, error, mention, assignment
  title     String
  message   String
  entityId  String?  @map("entity_id") // ID of related entity (lead, task, etc.)
  entityType String? @map("entity_type") // lead, task, deal, etc.
  actionUrl String?  @map("action_url") // Where to go when clicked
  metadata  Json?    // Extra data (e.g. { "dealValue": 5000 })
  isRead    Boolean  @default(false) @map("is_read")
  isArchived Boolean @default(false) @map("is_archived")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sender User?  @relation("NotificationSender", fields: [senderId], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, isRead])
  @@map("notification_deliveries")
}

model NotificationQuota {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @db.Uuid @map("user_id")
  channel   String
  limit     Int
  used      Int      @default(0)
  period    String   // "daily", "monthly"
  resetAt   DateTime @map("reset_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId, channel, period])
  @@map("notification_quotas")
}

model GoalPlan {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  period    String
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  status    String   @default("active")
  isPinned  Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  targets GoalTarget[]

  @@index([tenantId, period])
  @@index([tenantId, status])
  @@map("goal_plans")
}

model GoalTarget {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid @map("tenant_id")
  planId      String   @db.Uuid @map("plan_id")
  
  subjectType String   @map("subject_type") // user, team, all
  subjectId   String   @map("subject_id")
  
  metricKey   String   @map("metric_key")
  targetValue Decimal  @map("target_value") @db.Decimal(10, 2)
  weight      Decimal? @db.Decimal(5, 2)
  bonusAmount Decimal? @map("bonus_amount") @db.Decimal(14, 2)
  
  achievedAt  DateTime? @map("achieved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan GoalPlan @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([subjectType, subjectId])
  @@map("goal_targets")
}

model ScheduledJob {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  name      String
  schedule  String   // cron expression
  handler   String
  isEnabled Boolean  @default(true) @map("is_enabled")
  lastRunAt DateTime? @map("last_run_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  runs JobRun[]

  @@map("scheduled_jobs")
}

model JobRun {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  jobId     String   @db.Uuid @map("job_id")
  startedAt DateTime @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  status    String   // running, success, failed
  result    Json?
  error     String?

  tenant Tenant @relation(fields: [tenantId], references: [id])
  job ScheduledJob @relation(fields: [jobId], references: [id])

  @@index([jobId])
  @@map("job_runs")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  type      String   // direct, group, channel
  title     String?
  entityType String? @map("entity_type") // team, lead, etc.
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  participants ConversationParticipant[]
  messages Message[]

  @@index([tenantId, type])
  @@map("conversations")
}

model ConversationParticipant {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  conversationId String @db.Uuid @map("conversation_id")
  userId    String   @db.Uuid @map("user_id")
  role      String   @default("member") // admin, member
  joinedAt  DateTime @default(now()) @map("joined_at")
  lastReadAt DateTime? @map("last_read_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  conversationId String @db.Uuid @map("conversation_id")
  senderId  String   @db.Uuid @map("sender_id")
  content   String?
  contentType String @default("text") @map("content_type") // text, image, file
  fileId    String?  @db.Uuid @map("file_id")
  metadata  Json?
  
  replyToId String?  @db.Uuid @map("reply_to_id")
  replyTo   Message? @relation("ReplyTo", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("ReplyTo")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  editedAt  DateTime? @map("edited_at")
  deletedAt DateTime? @map("deleted_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender User @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}
